"use strict";function addDates(a){a.forEach(function(a){a._date=new Date(a.ErrorDateTimeUtc),a.date=d3.time.format("%Y.%m.%d")(a._date)})}function T(a,b){function c(a,c,d){console.log(a.length,c,d);var e=DD.tree2(a,c,d);return DD.addParent(e),DD.byDate(e),DD.calcStat(e),DD.addHeads(e),DD.calcDelta(e),DD.redDots(e,b.redgreen.deltaRed),e}function d(a,c,d,e,g,j,k){function l(a){if(console.log(a.keys.ErrorType,a),a.keys.ErrorType&&a.values.length&&B.showErrorHash!=a.hash){B.errorsDiv&&B.errorsDiv.remove();var b=a.values.map(function(a){return a.ErrorMessage}),c=E.filter(function(b){return b.hash==a.hash}).select("td.head-v").append("div").classed("error-info",!0).on("click",function(){d3.event.stopPropagation(),B.showErrorHash=0,c.remove()});c.selectAll("p").data(b).enter().append("p").html(function(a){return a}),console.log(console.log(b)),B.showErrorHash=a.hash,B.errorsDiv=c}}function m(a,b){var c=!0;return d3.values(a.keys).forEach(function(a,d){a!=d3.values(b.keys)[d]&&(c=!1)}),c}function n(a,b){B.errorsDiv&&B.errorsDiv.remove();var c;console.log(b.level),b.level>0&&(a.filter(function(a){return a.level==b.level&&m(b,a)}).classed("folded",function(a){return c=a.folded=!a.folded}),c?a.filter(function(a){return a.level<b.level&&m(b,a)}).classed("hidden",1).classed("folded",function(a){return a.folded=!0}):a.filter(function(a){return a.level==b.level-1&&m(b,a)}).classed("hidden",0))}function p(a){n(F.filter(function(a){return"v"!=a.head}),a)}function q(a){n(D,a)}function r(a,b,c){console.log(a,b,c,c[b]),c[b]?(c[b]=!1,a.filter(function(a){return a.depth==b}).classed("folded",function(a){return a.folded=!1}),a.filter(function(a){return a.depth==b+1}).classed("hidden",0)):(c[b]=!0,a.filter(function(a){return a.depth>=b}).classed("folded",function(a){return a.folded=!0}),a.filter(function(a){return a.depth>b}).classed("hidden",!0))}function s(a){w(a,"delta",function(a){return a.delta})}function v(a){w(a,"value",function(a){return a.values.length})}function w(a,b,d){function e(b,c,f){var g,i=c[f-1],j=b.filter(function(a){return d3.values(a.keys).length==f}).sort(function(b,c){return(d(c.columns[h])-d(b.columns[h]))*(2*a.sortDir-1)});return j.forEach(function(a){f<=c.length&&(g=b.filter(function(b){return b.keys[i]==a.keys[i]}),a.children=e(g,c,f+1))}),j}function f(a){var b=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];return a.forEach(function(a){b.push(a.i),f(a.children,b)}),b}B.errorsDiv&&B.errorsDiv.remove(),dash.sortColumn=a;var h=c[0].columns.indexOf(a);dash.sortDir=a.sortDir=!a.sortDir,H.selectAll(".sort-arrow").classed("enabled",0).text("▼▲"),d3.select("value"==b?a.thisValue:a.thisDelta).classed("enabled",1).text(a.sortDir?"▼":"▲");var i=e(c.filter(function(a,b){return b}),g,1),j=f(i);console.log(c.map(function(a){return a.i}),c,i,j,c.filter(function(a,b){return b})),E.sort(function(a,b){return j.indexOf(a.i)-j.indexOf(b.i)})}function x(a){return a?(a>0?"+":"")+Math.round(100*a)+"%":""}function y(a,b){return d3.values(a)[b]}function z(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}function A(a,b){var c={};for(var d in a)c[d]=a[d].replace(/_/g," "),c[d]="AssociatedStandard"==d?c[d].replace("CCSS.ELA-","").replace("LITERACY.","Literacy. "):z(c[d]);return b&&(c.overall="All "+b+"s"),c}console.log(d,c,o),this.type=d,i="base"!=d;{var B=this,C=a.append("tbody"),D=C.selectAll("tr").data(c).enter().append("tr").attr("class",function(a){return(a.head?"level-head ":"")+" level-"+a.level}),E=(D.filter(function(a){return a.head}),this.trBody=D.filter(function(a){return!a.head}).on("click","base"==d?h:l).classed("red-dot",function(a){return a.redDot})),F=D.selectAll("td").data(function(a){return a.columns}).enter().append("td"),G=F.filter(function(a){return a.head}).attr("class",function(a){return"level-head level-"+a.level+" depth-"+a.depth}),H=G.filter(function(a){return"h"==a.head}).classed("head-h",1),I=H.append("div").text(function(a){return y(A(a.keys,j),a.depth)}).on("click",p).classed("head-name",1),J=(H.filter(function(a){return a.withDate}).append("div").attr("class","sort-delta sort-arrow").text("▼ ▲").on("click",s).each(function(a){a.thisDelta=this}),H.append("div").attr("class","sort-value sort-arrow").text("▼ ▲").on("click",v).each(function(a){a.thisValue=this}),G.filter(function(a){return"v"==a.head}).attr("class",function(a){return"head-v level-head level-"+a.level+" depth-"+a.depth})),K=(J.filter(function(a){return a.level}).on("click",function(a){a.level&&d3.event.stopPropagation(),q(a)}),J.append("span").classed("dot",1),J.append("span").text(function(a){return y(A(a.keys,k),a.depth)}),F.filter(function(a){return!a.head})),L=K.append("div").classed("time-data",1),M=K.append("div").classed("value-data",1),N=(L.append("div").classed("sparcle",1).filter(function(a){return a.byDate}).append("svg").attr("shape-rendering","optimizeSpeed").attr("width",u).attr("height",t).append("path").attr("d",f),M.append("div").classed("barchart",1));N.append("div").classed("bar",1).style("width",function(a){return u*a.values.length/a.stat.max+"px"}),L.append("div").classed("delta numbers",1).filter(function(a){return a.byDate.length>1}).text(function(a){return x(a.delta)}),M.append("div").classed("value numbers",1).text(function(a){return a.values.length}),K.filter(function(a){return a.byDate}).classed("with-time",1).classed("delta-pos",function(a){return a.delta<b.redgreen.deltaGreen}).classed("delta-neg",function(a){return a.delta>b.redgreen.deltaRed})}this.topleft=a.select("tr.level-head td.head-v").classed("topleft-cell",1),J.append("span").classed("expander",1),I.append("span").classed("expander",1),"info"==d&&N.each(function(){this.parentNode.appendChild(this)});var O={h:[],v:[]};return this.fold={},this.fold.h=function(a){return r(F.filter(function(a){return"v"!=a.head}),a,O.h)},this.fold.v=function(a){return r(D,a,O.v)},this}function e(a,b){var c=!0;for(var d in a)b[d]!=a[d]&&(c=!1);return c}function f(a){var b=d3.scale.linear().range([1,(i?w:u)-1]).domain(r),c=d3.scale.linear().range([i?v-20:t-1,1]).domain([0,a.dateStat.max]),d=d3.svg.line().x(function(a){return b(a.date)}).y(function(a){return c(a.value)});return d(a.byDate)}function g(a,b,c,d){{var e=a.node().parentNode,f=e.offsetWidth,g=e.offsetHeight,h=d3.scale.linear().range([1,f-1]).domain(d||d3.extent(b,function(a){return a.date})),i=d3.scale.linear().range([g-20,1]).domain(c||d3.extent(b,function(a){return a.value})),j=d3.svg.line().x(function(a){return h(a.date)}).y(function(a){return i(a.value)}),k=a.attr("width",f).attr("height",g).append("path").datum(b).attr("d",j);a.append("line").attr({x1:h(0),y1:i(0),x2:h.range()[1],y2:i(0)+1,"class":"axis"}),a.selectAll("text").data(d).enter().append("text").attr({"class":function(a,b){return"dates date-"+b},x:function(a){return h(a)},y:i(0),dy:"1.25em"}).text(function(a){return d3.time.format("%d %b %Y")(a)})}return a.append("line").attr({x1:h.range()[0],y1:i(0)+1,x2:h.range()[0],y2:i(0)+6,"class":"axis"}),a.append("line").attr({x1:h.range()[1],y1:i(0)+1,x2:h.range()[1],y2:i(0)+6,"class":"axis"}),{path:k,y:i}}function h(b){function f(){d3.selectAll(".dash-app *").classed("blured",0),l.remove()}console.log(b),d3.selectAll(".dash-app div").classed("blured",1);var h,i=a.filter(function(a){return e(b.keys,a)}),j=c(i,m,["overall"]),k=c(i,n,["overall"]),l=d3.select(".dash-app").append("div").classed("overlay",1),s=(l.append("div").classed("close-button",1).on("click",f),l.append("div").classed("title",1).text(d3.values(b.keys).reduce(function(a,b){return a+(a?" / ":"")+(b||"")},"").replace("Overall / ","").replace("Overall","All "+p+"s")),l.append("div").classed("chart",1).append("svg")),t=b.columns[1],u=l.append("div").classed("tables-wrap",1).append("div").classed("tables",1),v=u.append("div").classed("info-table-wrap",1).append("table").classed("info-table-1",1),w=u.append("div").classed("info-table-wrap",1).append("table").classed("info-table-2",1);t.byDate.length&&(h=g(s,t.byDate,[0,t.dateStat.max],r,!0)),console.log(b,t,h),j.forEach(function(a,b){return a.i=b}),k.forEach(function(a,b){return a.i=b});var x=new d(v,j,"info",["overall"],m,p,o);x.fold.v(0),x.topleft.text("Errors by "+o),x.infoKeys=b.keys;var y=new d(w,k,"info",["overall"],n,p,q);y.fold.v(0),y.topleft.text("Errors by "+q),y.infoKeys=b.keys}var i,j=arguments.length<=2||void 0===arguments[2]?".dash-table":arguments[2],k=b.vKeys,l=b.hKeys,m=b.hKeysFull,n=b.fKeys,o=b.hName,p=b.vName,q=b.fName,r=d3.extent(a,function(a){return a._date}),s=c(a,k,l),t=23,u=40,v=23,w=80;s.forEach(function(a,b){return a.i=b}),console.log(b,k,p,l,o,n,a,s),d3.select(j).select("table").remove();var x=d3.select(j).append("table"),y=new d(x,s,"base",l,k,o,p);return y.fold.h(1),y.fold.v(1),this}var DD={hashKeys:function(a,b){if(b&&b.length)return b.reduce(function(b,c){return""+b+(a[c]||"")},"");var c="";for(var d in a)c+=a[d];return c},filterByKey:function(a,b){"string"==typeof b&&(b=[b]);var c={};return b.forEach(function(b){return c[b]=a[b]}),c},_agg:function(a,b,c){"string"==typeof b&&(b=[b]);var d={};return a.forEach(function(a,e){var f=DD.hashKeys(a,b);c?(d[f]||(d[f]={keys:DD.filterByKey(a,b),ids:[]}),d[f].ids.push(e)):(d[f]||(d[f]={keys:DD.filterByKey(a,b),values:[]}),d[f].values.push(a))}),d3.values(d)},aggIDs:function(a,b){return DD._agg(a,b,!0)},agg:function(a,b){return DD._agg(a,b)},treeKeys:function(a,b){"string"==typeof b&&(b=[b]);var c={},d=c;return a.forEach(function(a){d=c,b.forEach(function(b){d[a[b]]||(d[a[b]]={}),d=d[a[b]]})}),c},sortBy:function(a,b){a.sort(function(a,c){return a[b]<c[b]?-1:1})},_tree:function(a,b,c){"string"==typeof b&&(b=[b]);var d=[],e=[];return b.forEach(function(b){e.push(b),d=d.concat(c?DD.aggIDs(a,e):DD.agg(a,e))}),d.forEach(function(a){a.hash=DD.hashKeys(a.keys,b),a.level=b.length-d3.keys(a.keys).length,a.depth=d3.keys(a.keys).length-1}),DD.sortBy(d,"hash"),d},tree:function(a,b){return DD._tree(a,b)},treeIDs:function(a,b){return DD._tree(a,b,!0)},tree2:function(a,b,c){var d={};"string"==typeof b&&(b=[b]),"string"==typeof c&&(c=[c]);var e=DD.tree(a,b);return e.forEach(function(a){a.columns=DD.tree(a.values,c),a.columns.forEach(function(a){return d[a.hash]=a.keys})}),e.forEach(function(a){for(var b in d)a.columns.find(function(a){return a.hash==b})||a.columns.push({hash:b,keys:d[b],values:[],level:c.length-d3.keys(d[b]).length,depth:d3.keys(d[b]).length-1});DD.sortBy(a.columns,"hash")}),e},addParent:function(a){var b,c=[];c[a[0].level+1]={hash:"rowRoot"},a.forEach(function(a){a.level&&(c[a.level]=a),a.parent=c[a.level+1],b=[],b[a.columns[0].level+1]={hash:"columnRoot"},a.columns.forEach(function(a){a.level&&(b[a.level]=a),a.parent=b[a.level+1]})})},calcStat:function(a){var b=[],c=[];a.forEach(function(a){a.columns.forEach(function(d){var e,f,g=d.values.length,h=d3.max(d.byDate,function(a){return a.value});b[a.parent.hash]||(b[a.parent.hash]=[],c[a.parent.hash]=[]),b[a.parent.hash][d.parent.hash]||(b[a.parent.hash][d.parent.hash]={min:1e6,max:0},c[a.parent.hash][d.parent.hash]={min:1e6,max:0}),e=b[a.parent.hash][d.parent.hash],b[a.parent.hash][d.parent.hash]={min:Math.min(e.min,g),max:Math.max(e.max,g)},f=c[a.parent.hash][d.parent.hash],c[a.parent.hash][d.parent.hash]={min:Math.min(f.min,h),max:Math.max(f.max,h)}})}),a.forEach(function(a){a.columns.forEach(function(d){d.stat=b[a.parent.hash][d.parent.hash],d.dateStat=c[a.parent.hash][d.parent.hash]})})},calcDelta:function(a){a.forEach(function(a){a.columns.forEach(function(a){a.byDate&&a.byDate.length>1&&(a.delta=(a.byDate[a.byDate.length-1].value-a.byDate[0].value)/a.byDate[0].value)})})},redDots:function(a,b){a.forEach(function(a){0===a.level&&a.columns.forEach(function(c){c.delta>b&&(a.redDot=!0)})});for(var c,d=!1,e=!0,f=a.length-1;f>=0;f--)c=a[f],0===c.level?(e&&(e=d=!1),c.redDot&&(d=!0)):(c.redDot=d,e=!0)},byDate:function(a){a.forEach(function(a){a.columns.forEach(function(a){a.byDate=DD.tree(a.values,["date"]).map(function(a){return{date:a.values[0]._date,value:a.values.length}})})})},addHeads:function(a){a.unshift({columns:a[0].columns.map(function(a){return{keys:a.keys,level:a.level,depth:a.depth,head:"h"}}),head:"h"}),a.forEach(function(a){a.columns.unshift({keys:a.keys,level:a.level,depth:a.depth,head:"v"})}),a[0].columns.forEach(function(b,c){b.withDate=a.map(function(a){return a.columns[c].byDate&&a.columns[c].byDate.length>0}).find(function(a){return a})})}},APIurl="data/data2.json",container=".dash-app",dash={},raw,meta={},redgreen={deltaRed:.1,deltaGreen:-.1},classes=[{name:"Class / Student",keys:["ClassName","StudentName"]},{name:"Error type",keys:["ErrorCategory","AssociatedStandard","ErrorType"]},{name:"Subject / Assignment",keys:["SubjectName","AssignmentName"]}],initView=function(){function a(a,c){return b.append("div").classed(a+" selector",1).append("ul").selectAll("li").data(classes).enter().append("li").text(function(a){return a.name}).on("click",c)}var b=d3.select(container).append("div").classed("controls",1);dash.vMenu=a("vselector",selectV),dash.hMenu=a("hselector",selectH),dash.filter=b.append("div").classed("dash-filter",1),dash.filter.name=dash.filter.append("div").classed("filter-name",1),dash.filter.list=dash.filter.append("div").classed("filter-list",1),dash.tableWrap=d3.select(container).append("div").classed("dash-table",1)},selectV=function(a){dash.vClass=a,dash.vMenu.classed("active",0).filter(function(b){return a.name==b.name}).classed("active",1),dash.hMenu.classed("hidden",0).filter(function(b){return a.name==b.name}).classed("hidden",1),selectH(a.name==classes[0].name?classes[1]:classes[0],a)},selectH=function(a){dash.hClass=a,dash.hMenu.classed("active",0).filter(function(b){return a.name==b.name}).classed("active",1),updateFilter(classes.find(function(b){return b.name!=a.name&&b.name!=dash.vClass.name})),meta.hKeys=a.keys.map(function(a){return a}).slice(0,-1),meta.hKeysFull=a.keys.map(function(a){return a}),meta.hKeys.unshift("overall"),meta.vKeys=dash.vClass.keys.map(function(a){return a}),meta.vKeys.unshift("overall"),meta.vName=dash.vClass.name,meta.hName=dash.hClass.name,meta.redgreen=redgreen,console.log(raw,meta),dash.table=new T(raw,meta)},updateFilter=function(a){function b(){var a=!dash.filter.list.classed("active");dash.filter.list.classed("active",a),d3.selectAll(".dash-app .dash-table").classed("blured",a)}function c(a){console.log(a),b(),dash.filter.name.text(d3.values(a.keys).reduce(function(a,b){return a+(a?" / ":"")+(b||"")},"").replace("Overall / ","").replace("Overall",d));var c=raw.filter(function(b){var c=!0;for(var d in a.keys)a.keys[d]!=b[d]&&(c=!1);return c});console.log(raw.length,c.length),dash.table=new T(c,meta)}var d="All "+a.name+"s",e=a.keys.map(function(a){return a});e.unshift("overall"),dash.filter.name.text(d).on("click",b),dash.filter.list.select("ul").remove(),dash.filter.list.append("ul").selectAll("li").data(DD.tree(raw,e)).enter().append("li").attr("class",function(a){return"depth-"+a.depth}).text(function(a){return d3.values(a.keys)[a.depth].replace("Overall",d)}).on("click",c),meta.fKeys=a.keys.map(function(a){return a}),meta.fName=a.name},loadData=function(a,b){if(a)throw a;if(b.ErrorMessage)throw b.ErrorMessage;if(!b.Success||!b.RowCount||!b.Data)throw b;raw=b.Data,addDates(raw),raw.forEach(function(a){return a.overall="Overall"}),selectV(classes[0])};d3.json(APIurl,loadData),initView();